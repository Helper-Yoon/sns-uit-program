<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>견적 관리 시스템</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        .header { text-align: center; margin-bottom: 50px; }
        .header h1 { font-size: 48px; font-weight: 200; margin-bottom: 10px; }
        .header h1 span { color: #1E6FFF; font-weight: 400; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: #000; border: 1px solid #222; margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .control-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        
        .btn { padding: 12px 28px; background: transparent; color: #999; border: 1px solid #444; font-size: 15px; font-weight: 500; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s; }
        .btn:hover { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary:hover { background: #1E6FFF; color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-box { display: flex; gap: 10px; align-items: center; }
        .search-input { padding: 10px 15px; background: #111; border: 1px solid #333; color: #fff; font-size: 14px; width: 300px; }
        .search-input:focus { outline: none; border-color: #1E6FFF; }
        
        .quote-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .quote-card { background: #111; border: 1px solid #333; padding: 25px; cursor: pointer; transition: all 0.3s; position: relative; }
        .quote-card:hover { border-color: #1E6FFF; transform: translateY(-2px); }
        .quote-card.selected { border-color: #1E6FFF; background: #0a0a0a; }
        
        .quote-title { font-size: 18px; font-weight: 500; color: #1E6FFF; margin-bottom: 15px; }
        .quote-summary { font-size: 14px; color: #999; line-height: 1.6; margin-bottom: 10px; }
        .quote-meta { font-size: 12px; color: #666; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; display: flex; justify-content: space-between; }
        
        .quote-actions { display: flex; gap: 10px; margin-top: 10px; }
        .quote-actions .btn { padding: 5px 12px; font-size: 12px; }
        
        .editor-panel { background: #111; border: 1px solid #333; padding: 30px; margin-bottom: 40px; display: none; }
        .editor-panel.active { display: block; }
        
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; font-size: 14px; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        .form-input, .form-textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; font-size: 15px; font-family: inherit; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: #1E6FFF; }
        .form-textarea { min-height: 300px; resize: vertical; line-height: 1.6; }
        
        .preview-panel { background: #000; border: 1px solid #222; padding: 25px; margin-top: 20px; }
        .preview-content { font-size: 14px; line-height: 1.8; color: #ddd; white-space: pre-line; }
        .preview-summary { margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; color: #1E6FFF; font-weight: 500; }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #111; border: 1px solid #1E6FFF; color: #fff; font-size: 14px; z-index: 1000; animation: slideIn 0.3s; display: none; }
        .notification.show { display: block; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .empty-state { text-align: center; padding: 100px 20px; color: #666; }
        .empty-state h3 { font-size: 24px; font-weight: 300; margin-bottom: 10px; }
        
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .search-box { width: 100%; }
            .search-input { flex: 1; }
            .quote-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>견적 <span>관리 시스템</span></h1>
        </div>
        
        <div class="control-bar">
            <div class="control-buttons">
                <button class="btn primary" onclick="showEditor()">새 견적 작성</button>
                <button class="btn" onclick="loadQuotes()">새로고침</button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="견적 검색..." onkeyup="searchQuotes()">
            </div>
        </div>
        
        <div class="editor-panel" id="editorPanel">
            <h3 style="margin-bottom: 25px; font-weight: 300;">견적 편집기</h3>
            <form onsubmit="saveQuote(event)">
                <div class="form-group">
                    <label class="form-label">제목</label>
                    <input type="text" class="form-input" id="quoteTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">견적 내용</label>
                    <textarea class="form-textarea" id="quoteContent" required placeholder="견적 내용을 입력하세요..."></textarea>
                </div>
                <div class="preview-panel">
                    <div class="form-label">미리보기</div>
                    <div class="preview-content" id="previewContent"></div>
                    <div class="preview-summary" id="previewSummary"></div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="submit" class="btn primary">저장</button>
                    <button type="button" class="btn" onclick="hideEditor()">취소</button>
                    <button type="button" class="btn" onclick="copyQuote()">클립보드 복사</button>
                </div>
            </form>
        </div>
        
        <div class="quote-grid" id="quoteGrid">
            <div class="empty-state">
                <h3>저장된 견적이 없습니다</h3>
                <p>새 견적을 작성해보세요</p>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd295aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
        
        const { createClient } = window.supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentQuotes = [];
        let editingQuoteId = null;
        
        // 초기화
        async function init() {
            await createTableIfNotExists();
            await loadQuotes();
            
            // 실시간 미리보기
            document.getElementById('quoteContent').addEventListener('input', updatePreview);
        }
        
        // 테이블 생성 (없을 경우)
        async function createTableIfNotExists() {
            try {
                const { error } = await supabaseClient.from('quotes').select('id').limit(1);
                if (error && error.code === '42P01') {
                    // 테이블이 없으면 생성
                    console.log('테이블을 생성해야 합니다. Supabase 대시보드에서 quotes 테이블을 생성하세요.');
                }
            } catch (e) {
                console.log('테이블 확인 중 오류:', e);
            }
        }
        
        // 견적 처리 함수
        function processQuoteContent(content) {
            let processed = content;
            
            // 설치비 정리
            processed = processed.replace(/- 설치비:\s*([0-9,]+)\s*\n.*?- 주말설치시 추가설치비:\s*([0-9,]+)/g, 
                '- 설치비: $1 (주말할증 $2)');
            
            // 유형: 번호이동 제거
            processed = processed.replace(/- 유형:.*번호이동.*\n/g, '');
            
            // 통신사 단순화
            processed = processed.replace(/- 통신사:\s*(\w+)\([^)]*\)\([^)]*\)/g, '- 통신사: $1');
            processed = processed.replace(/- 통신사:\s*(\w+)\([^)]*\)/g, '- 통신사: $1');
            
            return processed.trim();
        }
        
        // 요약 생성
        function generateSummary(content) {
            const lines = content.split('\n');
            const summary = [];
            
            // 총 요금과 사은품 찾기
            lines.forEach(line => {
                if (line.includes('★ 총 요금') || line.includes('☆ 총 사은품')) {
                    summary.push(line.replace(/[★☆]/g, '').trim());
                }
            });
            
            if (summary.length === 0) {
                // 월요금과 사은품 정보 추출
                const monthlyFee = content.match(/월요금:\s*([0-9,]+)/);
                const benefit = content.match(/사은품:\s*([0-9,]+)/);
                
                if (monthlyFee) summary.push(`월요금: ${monthlyFee[1]}원`);
                if (benefit) summary.push(`사은품: ${benefit[1]}원`);
            }
            
            return summary.join(' / ');
        }
        
        // 미리보기 업데이트
        function updatePreview() {
            const content = document.getElementById('quoteContent').value;
            const processed = processQuoteContent(content);
            const summary = generateSummary(processed);
            
            document.getElementById('previewContent').textContent = processed;
            document.getElementById('previewSummary').textContent = summary || '요약 정보가 표시됩니다';
        }
        
        // 견적 로드
        async function loadQuotes() {
            try {
                const { data, error } = await supabaseClient
                    .from('quotes')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                currentQuotes = data || [];
                displayQuotes(currentQuotes);
                
            } catch (error) {
                console.error('견적 로드 실패:', error);
                showNotification('견적 로드 실패', 'error');
            }
        }
        
        // 견적 표시
        function displayQuotes(quotes) {
            const grid = document.getElementById('quoteGrid');
            
            if (quotes.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>저장된 견적이 없습니다</h3>
                        <p>새 견적을 작성해보세요</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = quotes.map(quote => `
                <div class="quote-card" onclick="selectQuote('${quote.id}')">
                    <div class="quote-title">${quote.title}</div>
                    <div class="quote-summary">${quote.summary || '요약 없음'}</div>
                    <div class="quote-meta">
                        <span>${new Date(quote.created_at).toLocaleDateString()}</span>
                        <span>${quote.content.length}자</span>
                    </div>
                    <div class="quote-actions">
                        <button class="btn" onclick="editQuote('${quote.id}'); event.stopPropagation();">수정</button>
                        <button class="btn" onclick="deleteQuote('${quote.id}'); event.stopPropagation();">삭제</button>
                        <button class="btn primary" onclick="copyQuoteContent('${quote.id}'); event.stopPropagation();">복사</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 편집기 표시
        function showEditor() {
            document.getElementById('editorPanel').classList.add('active');
            document.getElementById('quoteTitle').value = '';
            document.getElementById('quoteContent').value = '';
            document.getElementById('previewContent').textContent = '';
            document.getElementById('previewSummary').textContent = '';
            editingQuoteId = null;
        }
        
        // 편집기 숨기기
        function hideEditor() {
            document.getElementById('editorPanel').classList.remove('active');
            editingQuoteId = null;
        }
        
        // 견적 저장
        async function saveQuote(event) {
            event.preventDefault();
            
            const title = document.getElementById('quoteTitle').value;
            const content = document.getElementById('quoteContent').value;
            const processed = processQuoteContent(content);
            const summary = generateSummary(processed);
            
            try {
                if (editingQuoteId) {
                    // 수정
                    const { error } = await supabaseClient
                        .from('quotes')
                        .update({
                            title,
                            content: processed,
                            summary,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', editingQuoteId);
                    
                    if (error) throw error;
                    showNotification('견적이 수정되었습니다');
                } else {
                    // 신규
                    const { error } = await supabaseClient
                        .from('quotes')
                        .insert({
                            title,
                            content: processed,
                            summary,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                    showNotification('견적이 저장되었습니다');
                }
                
                hideEditor();
                await loadQuotes();
                
            } catch (error) {
                console.error('저장 실패:', error);
                showNotification('저장 실패', 'error');
            }
        }
        
        // 견적 수정
        function editQuote(id) {
            const quote = currentQuotes.find(q => q.id === id);
            if (!quote) return;
            
            editingQuoteId = id;
            document.getElementById('quoteTitle').value = quote.title;
            document.getElementById('quoteContent').value = quote.content;
            updatePreview();
            document.getElementById('editorPanel').classList.add('active');
        }
        
        // 견적 삭제
        async function deleteQuote(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('quotes')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('견적이 삭제되었습니다');
                await loadQuotes();
                
            } catch (error) {
                console.error('삭제 실패:', error);
                showNotification('삭제 실패', 'error');
            }
        }
        
        // 견적 복사
        function copyQuoteContent(id) {
            const quote = currentQuotes.find(q => q.id === id);
            if (!quote) return;
            
            const fullContent = `${quote.title}\n\n${quote.content}\n\n${quote.summary}`;
            navigator.clipboard.writeText(fullContent).then(() => {
                showNotification('클립보드에 복사되었습니다');
            });
        }
        
        // 현재 편집 중인 견적 복사
        function copyQuote() {
            const title = document.getElementById('quoteTitle').value;
            const content = document.getElementById('previewContent').textContent;
            const summary = document.getElementById('previewSummary').textContent;
            
            const fullContent = `${title}\n\n${content}\n\n${summary}`;
            navigator.clipboard.writeText(fullContent).then(() => {
                showNotification('클립보드에 복사되었습니다');
            });
        }
        
        // 견적 선택
        function selectQuote(id) {
            const cards = document.querySelectorAll('.quote-card');
            cards.forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        
        // 검색
        function searchQuotes() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query) {
                displayQuotes(currentQuotes);
                return;
            }
            
            const filtered = currentQuotes.filter(quote => 
                quote.title.toLowerCase().includes(query) ||
                quote.content.toLowerCase().includes(query) ||
                (quote.summary && quote.summary.toLowerCase().includes(query))
            );
            
            displayQuotes(filtered);
        }
        
        // 알림
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.borderColor = type === 'error' ? '#FF0000' : '#1E6FFF';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 시작
        init();
    </script>
</body>
</html>
