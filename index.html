<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>견적 관리 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        .header { text-align: center; margin-bottom: 40px; position: relative; }
        .header h1 { font-size: 48px; font-weight: 200; margin-bottom: 10px; }
        .header h1 span { color: #1E6FFF; font-weight: 400; }
        .admin-btn { position: absolute; top: 10px; right: 10px; padding: 8px 16px; background: #222; border: 1px solid #444; color: #666; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .admin-btn:hover { border-color: #FFD700; color: #FFD700; }
        .admin-btn.active { background: #FFD700; color: #000; }
        
        .carrier-selector { display: flex; justify-content: center; gap: 0; margin-bottom: 30px; background: #111; padding: 5px; border-radius: 12px; }
        .carrier-btn { padding: 15px 35px; background: transparent; color: #999; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; }
        .carrier-btn:first-child { border-radius: 8px 0 0 8px; }
        .carrier-btn:last-child { border-radius: 0 8px 8px 0; }
        .carrier-btn:hover { color: #fff; }
        .carrier-btn.kt.active { background: #FF0000; color: #fff; }
        .carrier-btn.skt.active { background: #FF6B00; color: #fff; }
        .carrier-btn.lg.active { background: #E6007E; color: #fff; }
        
        .mode-toggle { display: flex; justify-content: center; gap: 0; margin-bottom: 30px; }
        .mode-btn { padding: 12px 40px; background: #111; color: #999; border: 1px solid #333; font-size: 15px; cursor: pointer; transition: all 0.3s; }
        .mode-btn:first-child { border-radius: 8px 0 0 8px; }
        .mode-btn:last-child { border-radius: 0 8px 8px 0; border-left: none; }
        .mode-btn.active { background: #1E6FFF; color: #000; border-color: #1E6FFF; }
        
        .control-bar { display: flex; justify-content: flex-end; align-items: center; padding: 20px 30px; background: #000; border: 1px solid #222; margin-bottom: 40px; gap: 20px; }
        
        .btn { padding: 12px 28px; background: transparent; color: #999; border: 1px solid #444; font-size: 15px; font-weight: 500; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s; }
        .btn:hover { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary:hover { background: #1E6FFF; color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-box { display: flex; gap: 10px; align-items: center; }
        .search-input { padding: 10px 15px; background: #111; border: 1px solid #333; color: #fff; font-size: 14px; width: 300px; }
        .search-input:focus { outline: none; border-color: #1E6FFF; }
        
        .filter-section { 
            display: flex; 
            align-items: center; 
            gap: 30px; 
            padding: 20px 30px; 
            background: #111; 
            border-radius: 12px;
            margin-bottom: 30px; 
            justify-content: center;
        }
        
        .filter-toggles {
            display: flex;
            gap: 40px;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .filter-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: #333;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .filter-toggle.active { background: #1E6FFF; }
        .filter-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .filter-toggle.active .filter-toggle-slider { transform: translateX(24px); }
        
        .filter-label {
            font-size: 15px;
            color: #fff;
            font-weight: 500;
        }
        
        .quote-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; margin-bottom: 50px; }
        
        .quote-card { 
            background: linear-gradient(135deg, #0a0a0a, #111); 
            border: 2px solid #333; 
            border-radius: 16px; 
            padding: 25px; 
            cursor: pointer; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden;
        }
        .quote-card.has-upsell {
            background: linear-gradient(135deg, #0f0a00, #111);
            border-color: #444;
        }
        .quote-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, #1E6FFF, transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .quote-card.has-upsell::before {
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
        }
        .quote-card:hover::before { transform: translateX(100%); }
        .quote-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(30, 111, 255, 0.2); }
        .quote-card.favorite { 
            border: 2px solid #FFD700; 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            background: linear-gradient(135deg, #1a1a0a, #111);
        }
        
        .star-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: transparent; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #666;
            display: none;
            transition: all 0.3s;
        }
        .admin-mode .star-btn { display: block; }
        .star-btn:hover { color: #FFD700; transform: scale(1.2); }
        .star-btn.active { color: #FFD700; }
        
        .card-badges { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .badge { 
            display: inline-block; 
            padding: 5px 12px; 
            font-size: 11px; 
            font-weight: 600; 
            letter-spacing: 0.5px; 
            border-radius: 20px;
            background: linear-gradient(135deg, #333, #222);
            color: #999;
        }
        .badge.kt { background: linear-gradient(135deg, #FF0000, #CC0000); color: #fff; }
        .badge.skt { background: linear-gradient(135deg, #FF6B00, #CC5500); color: #fff; }
        .badge.lg { background: linear-gradient(135deg, #E6007E, #B30065); color: #fff; }
        .badge.upsell { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; font-weight: 800; }
        .badge.no-upsell { background: linear-gradient(135deg, #555, #333); color: #999; }
        .badge.wifi { background: linear-gradient(135deg, #0066CC, #004499); color: #fff; }
        
        .quote-title { font-size: 19px; font-weight: 600; color: #fff; margin-bottom: 15px; line-height: 1.4; }
        .quote-content { font-size: 14px; color: #aaa; line-height: 1.6; margin-bottom: 15px; max-height: 80px; overflow: hidden; }
        .quote-meta { font-size: 12px; color: #666; padding-top: 15px; border-top: 1px solid #333; display: flex; justify-content: space-between; }
        
        .quote-actions { display: flex; gap: 10px; margin-top: 15px; }
        .quote-actions .btn { padding: 8px 16px; font-size: 13px; border-radius: 8px; }
        
        .editor-panel { background: #111; border: 1px solid #333; border-radius: 16px; padding: 30px; margin-bottom: 40px; display: none; }
        .editor-panel.active { display: block; }
        
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; font-size: 14px; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        .form-input, .form-textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; font-size: 15px; font-family: inherit; border-radius: 8px; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: #1E6FFF; }
        .form-textarea { min-height: 400px; resize: vertical; line-height: 1.6; }
        
        .form-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; }
        
        /* 토글 스위치 스타일 */
        .toggle-container { display: flex; align-items: center; gap: 10px; }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active { background: #1E6FFF; }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider { transform: translateX(30px); }
        .toggle-label { font-size: 14px; color: #999; }
        
        /* FAB 버튼 */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1E6FFF, #0050FF);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(30,111,255,0.4);
            transition: all 0.3s;
            z-index: 1000;
        }
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 30px rgba(30,111,255,0.6);
        }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #111; border: 1px solid #1E6FFF; color: #fff; font-size: 14px; z-index: 1000; animation: slideIn 0.3s; display: none; border-radius: 8px; }
        .notification.show { display: block; }
        .notification.error { border-color: #FF0000; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .empty-state { text-align: center; padding: 100px 20px; color: #666; grid-column: 1 / -1; }
        .empty-state h3 { font-size: 24px; font-weight: 300; margin-bottom: 10px; }
        
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .password-modal.show { display: flex; }
        .password-box {
            background: #111;
            border: 1px solid #333;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        .password-input {
            padding: 10px;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            font-size: 16px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .quote-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .carrier-selector { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>견적 <span>관리 시스템</span></h1>
            <button class="admin-btn" id="adminBtn" onclick="toggleAdminMode()">관리자</button>
        </div>
        
        <div class="carrier-selector">
            <button class="carrier-btn kt" id="carrierKt" onclick="selectCarrier('kt')">KT</button>
            <button class="carrier-btn skt" id="carrierSkt" onclick="selectCarrier('skt')">SKT</button>
            <button class="carrier-btn lg" id="carrierLg" onclick="selectCarrier('lg')">LG U+</button>
        </div>
        
        <div class="mode-toggle">
            <button class="mode-btn active" id="modeDongpan" onclick="setMode('dongpan')">동판 모드</button>
            <button class="mode-btn" id="modeInternet" onclick="setMode('internet')">인터넷 모드</button>
        </div>
        
        <div class="control-bar">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="견적 검색..." onkeyup="searchQuotes()">
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-toggles">
                <div class="filter-item">
                    <div class="filter-toggle active" id="upsellFilter" onclick="toggleUpsellFilter()">
                        <div class="filter-toggle-slider"></div>
                    </div>
                    <span class="filter-label" id="upsellFilterLabel">업셀</span>
                </div>
                <div class="filter-item">
                    <div class="filter-toggle active" id="wifiFilter" onclick="toggleWifiFilter()">
                        <div class="filter-toggle-slider"></div>
                    </div>
                    <span class="filter-label" id="wifiFilterLabel">와이파이 O</span>
                </div>
            </div>
        </div>
        
        <div class="editor-panel" id="editorPanel">
            <h3 style="margin-bottom: 25px; font-weight: 300;">견적 편집기</h3>
            <form onsubmit="saveQuote(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">제목</label>
                        <input type="text" class="form-input" id="quoteTitle" required>
                    </div>
                    <div class="form-group" id="upsellGroup">
                        <label class="form-label">업셀 여부</label>
                        <div class="toggle-container">
                            <div class="toggle-switch active" id="upsellToggle" onclick="toggleUpsell()">
                                <div class="toggle-slider"></div>
                            </div>
                            <span class="toggle-label" id="upsellLabel">업셀</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">와이파이</label>
                        <div class="toggle-container">
                            <div class="toggle-switch active" id="wifiToggle" onclick="toggleWifi()">
                                <div class="toggle-slider"></div>
                            </div>
                            <span class="toggle-label" id="wifiLabel">있음</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">견적 내용</label>
                    <textarea class="form-textarea" id="quoteContent" required placeholder="견적 내용을 입력하세요..."></textarea>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="submit" class="btn primary">저장</button>
                    <button type="button" class="btn" onclick="hideEditor()">취소</button>
                </div>
            </form>
        </div>
        
        <div class="quote-grid" id="quoteGrid">
            <div class="empty-state">
                <h3>저장된 견적이 없습니다</h3>
                <p>새 견적을 작성해보세요</p>
            </div>
        </div>
    </div>
    
    <!-- FAB 버튼 -->
    <div class="fab" onclick="showEditor()">+</div>
    
    <div class="notification" id="notification"></div>
    
    <div class="password-modal" id="passwordModal">
        <div class="password-box">
            <h3 style="margin-bottom: 20px;">관리자 비밀번호</h3>
            <input type="password" class="password-input" id="passwordInput" placeholder="비밀번호 입력">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn primary" onclick="checkPassword()">확인</button>
                <button class="btn" onclick="closePasswordModal()">취소</button>
            </div>
        </div>
    </div>
    
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd295aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
        
        // 전역 변수
        let supabaseClient;
        let currentQuotes = [];
        let editingQuoteId = null;
        let filterUpsell = true; // true = 업셀만, false = 업셀거부만
        let filterWifi = true; // true = 와이파이O만, false = 와이파이X만
        let currentMode = 'dongpan';
        let currentCarrier = 'kt';
        let isAdminMode = false;
        let selectedUpsell = true;
        let selectedWifi = true;
        
        // 초기화
        async function init() {
            // Supabase 클라이언트 초기화
            if (window.supabase) {
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                console.error('Supabase 라이브러리를 로드할 수 없습니다');
                showNotification('Supabase 연결 실패', 'error');
                return;
            }
            
            // 기본 통신사 선택
            selectCarrier('kt');
            
            // 필터 기본값 설정 (업셀 ON, 와이파이 ON)
            filterUpsell = true;
            filterWifi = true;
            document.getElementById('upsellFilter').classList.add('active');
            document.getElementById('wifiFilter').classList.add('active');
            
            await loadQuotes();
            
            // 제목 자동 처리
            document.getElementById('quoteTitle').addEventListener('input', handleTitleInput);
            
            // 엔터키로 비밀번호 확인
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
        }
        
        // 통신사 선택
        function selectCarrier(carrier) {
            currentCarrier = carrier;
            document.querySelectorAll('.carrier-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('carrier' + carrier.charAt(0).toUpperCase() + carrier.slice(1)).classList.add('active');
            
            // SKT는 업셀 없음 - 필터를 업셀거부로 자동 변경
            if (carrier === 'skt') {
                document.getElementById('upsellGroup').style.display = 'none';
                selectedUpsell = false;
                
                // 필터도 업셀거부로 변경
                filterUpsell = false;
                document.getElementById('upsellFilter').classList.remove('active');
                document.getElementById('upsellFilterLabel').textContent = '업셀거부';
            } else {
                document.getElementById('upsellGroup').style.display = 'block';
                
                // 다른 통신사는 업셀로 복귀
                filterUpsell = true;
                document.getElementById('upsellFilter').classList.add('active');
                document.getElementById('upsellFilterLabel').textContent = '업셀';
            }
            
            // 카운트 업데이트 후 필터링
            updateCounts();
            filterQuotes();
        }
        
        // 모드 설정
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode === 'dongpan' ? 'modeDongpan' : 'modeInternet').classList.add('active');
            updateCounts();
            filterQuotes();
        }
        
        // 업셀 토글
        function toggleUpsell() {
            selectedUpsell = !selectedUpsell;
            const toggle = document.getElementById('upsellToggle');
            const label = document.getElementById('upsellLabel');
            
            if (selectedUpsell) {
                toggle.classList.add('active');
                label.textContent = '업셀';
            } else {
                toggle.classList.remove('active');
                label.textContent = '업셀거부';
            }
        }
        
        // 와이파이 토글
        function toggleWifi() {
            selectedWifi = !selectedWifi;
            const toggle = document.getElementById('wifiToggle');
            const label = document.getElementById('wifiLabel');
            
            if (selectedWifi) {
                toggle.classList.add('active');
                label.textContent = '있음';
            } else {
                toggle.classList.remove('active');
                label.textContent = '없음';
            }
        }
        
        // 관리자 모드 토글
        function toggleAdminMode() {
            if (!isAdminMode) {
                document.getElementById('passwordModal').classList.add('show');
                document.getElementById('passwordInput').focus();
            } else {
                isAdminMode = false;
                document.body.classList.remove('admin-mode');
                document.getElementById('adminBtn').classList.remove('active');
                showNotification('관리자 모드 종료');
            }
        }
        
        // 비밀번호 확인
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === '1250') {
                isAdminMode = true;
                document.body.classList.add('admin-mode');
                document.getElementById('adminBtn').classList.add('active');
                document.getElementById('passwordModal').classList.remove('show');
                document.getElementById('passwordInput').value = '';
                showNotification('관리자 모드 활성화');
            } else {
                showNotification('비밀번호가 틀렸습니다', 'error');
                document.getElementById('passwordInput').value = '';
            }
        }
        
        // 비밀번호 모달 닫기
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('show');
            document.getElementById('passwordInput').value = '';
        }
        
        // 즐겨찾기 토글
        async function toggleFavorite(id, event) {
            event.stopPropagation();
            
            const quote = currentQuotes.find(q => q.id === id);
            if (!quote) return;
            
            const newFavorite = !quote.favorite;
            
            try {
                const { error } = await supabaseClient
                    .from('quotes')
                    .update({ favorite: newFavorite })
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification(newFavorite ? '즐겨찾기 추가' : '즐겨찾기 제거');
                await loadQuotes();
                
            } catch (error) {
                console.error('즐겨찾기 토글 실패:', error);
                showNotification('즐겨찾기 변경 실패', 'error');
            }
        }
        
        // 제목 입력 처리
        function handleTitleInput() {
            const titleInput = document.getElementById('quoteTitle');
            let value = titleInput.value;
            
            // ▷ 자동 추가
            if (value && !value.startsWith('▷')) {
                titleInput.value = '▷ ' + value;
            }
        }
        
        // 견적 처리 함수
        function processQuoteContent(content) {
            let processed = content;
            
            // 설치비 정리
            processed = processed.replace(/- 설치비:\s*([0-9,]+)\s*\n.*?- 주말설치시 추가설치비:\s*([0-9,]+)/g, 
                '- 설치비: $1 (주말할증 $2)');
            
            // 유형: 번호이동 제거
            processed = processed.replace(/- 유형:.*번호이동.*\n/g, '');
            
            // 통신사 단순화
            processed = processed.replace(/- 통신사:\s*(\w+)\([^)]*\)\([^)]*\)/g, '- 통신사: $1');
            processed = processed.replace(/- 통신사:\s*(\w+)\([^)]*\)/g, '- 통신사: $1');
            
            return processed.trim();
        }
        
        // 견적 로드
        async function loadQuotes() {
            try {
                const { data, error } = await supabaseClient
                    .from('quotes')
                    .select('*')
                    .order('favorite', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                currentQuotes = data || [];
                updateCounts();
                filterQuotes();
                
            } catch (error) {
                console.error('견적 로드 실패:', error);
                showNotification('견적 로드 실패', 'error');
            }
        }
        
        // 카운트 업데이트
        function updateCounts() {
            const filtered = currentQuotes.filter(q => 
                (q.carrier === currentCarrier || !q.carrier) && 
                (q.mode === currentMode || !q.mode)
            );
            
            // 전체 카운트
            document.getElementById('countAll').textContent = filtered.length;
            
            // 업셀/업셀거부 카운트 (현재 필터 상태에 따라)
            if (filterUpsell) {
                const upsellCount = filtered.filter(q => q.upsell !== false).length;
                document.getElementById('countUpsell').textContent = upsellCount;
                document.getElementById('upsellFilterLabel').textContent = '업셀';
            } else {
                const noUpsellCount = filtered.filter(q => q.upsell === false).length;
                document.getElementById('countUpsell').textContent = noUpsellCount;
                document.getElementById('upsellFilterLabel').textContent = '업셀거부';
            }
            
            // 와이파이 카운트 (현재 필터 상태에 따라)
            if (filterWifi) {
                const wifiCount = filtered.filter(q => q.wifi !== false).length;
                document.getElementById('countWifi').textContent = wifiCount;
                document.getElementById('wifiFilterLabel').textContent = '와이파이 O';
            } else {
                const noWifiCount = filtered.filter(q => q.wifi === false).length;
                document.getElementById('countWifi').textContent = noWifiCount;
                document.getElementById('wifiFilterLabel').textContent = '와이파이 X';
            }
        }
        
        // 업셀 필터 토글
        function toggleUpsellFilter() {
            filterUpsell = !filterUpsell;
            const toggle = document.getElementById('upsellFilter');
            const label = document.getElementById('upsellFilterLabel');
            
            if (filterUpsell) {
                toggle.classList.add('active');
                label.textContent = '업셀';
            } else {
                toggle.classList.remove('active');
                label.textContent = '업셀거부';
            }
            
            filterQuotes();
        }
        
        // 와이파이 필터 토글
        function toggleWifiFilter() {
            filterWifi = !filterWifi;
            const toggle = document.getElementById('wifiFilter');
            const label = document.getElementById('wifiFilterLabel');
            
            if (filterWifi) {
                toggle.classList.add('active');
                label.textContent = '와이파이 O';
            } else {
                toggle.classList.remove('active');
                label.textContent = '와이파이 X';
            }
            
            filterQuotes();
        }
        
        // 견적 필터링
        function filterQuotes() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = currentQuotes;
            
            // 통신사 필터
            filtered = filtered.filter(q => q.carrier === currentCarrier || !q.carrier);
            
            // 모드 필터
            filtered = filtered.filter(q => q.mode === currentMode || !q.mode);
            
            // 업셀 필터
            if (filterUpsell) {
                filtered = filtered.filter(q => q.upsell !== false);
            } else {
                filtered = filtered.filter(q => q.upsell === false);
            }
            
            // 와이파이 필터
            if (filterWifi) {
                filtered = filtered.filter(q => q.wifi !== false);
            } else {
                filtered = filtered.filter(q => q.wifi === false);
            }
            
            // 검색 필터
            if (searchQuery) {
                filtered = filtered.filter(quote => 
                    quote.title.toLowerCase().includes(searchQuery) ||
                    quote.content.toLowerCase().includes(searchQuery)
                );
            }
            
            displayQuotes(filtered);
        }
        
        // 견적 표시
        function displayQuotes(quotes) {
            const grid = document.getElementById('quoteGrid');
            
            if (quotes.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>견적이 없습니다</h3>
                        <p>새 견적을 작성하거나 필터를 변경해보세요</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = quotes.map(quote => {
                const carrierName = {
                    'kt': 'KT',
                    'skt': 'SKT',
                    'lg': 'LG U+'
                }[quote.carrier] || currentCarrier.toUpperCase();
                
                // 견적 내용 요약 (처음 3줄)
                const lines = quote.content.split('\n').filter(line => line.trim());
                const summary = lines.slice(0, 3).join(' / ');
                
                return `
                    <div class="quote-card ${quote.favorite ? 'favorite' : ''} ${quote.upsell !== false ? 'has-upsell' : ''}" onclick="selectQuote('${quote.id}')">
                        <button class="star-btn ${quote.favorite ? 'active' : ''}" onclick="toggleFavorite('${quote.id}', event)">
                            ${quote.favorite ? '★' : '☆'}
                        </button>
                        <div class="card-badges">
                            <span class="badge ${quote.carrier || currentCarrier}">${carrierName}</span>
                            ${quote.upsell !== false ? '<span class="badge upsell">업셀</span>' : '<span class="badge no-upsell">업셀거부</span>'}
                            ${quote.wifi !== false ? '<span class="badge wifi">WiFi</span>' : ''}
                        </div>
                        <div class="quote-title">${quote.title}</div>
                        <div class="quote-content">${summary}</div>
                        <div class="quote-meta">
                            <span>${new Date(quote.created_at).toLocaleDateString()}</span>
                            <span>${quote.content.length}자</span>
                        </div>
                        <div class="quote-actions">
                            <button class="btn" onclick="editQuote('${quote.id}'); event.stopPropagation();">수정</button>
                            <button class="btn" onclick="deleteQuote('${quote.id}'); event.stopPropagation();">삭제</button>
                            <button class="btn primary" onclick="copyQuoteContent('${quote.id}'); event.stopPropagation();">복사</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 편집기 표시
        function showEditor() {
            document.getElementById('editorPanel').classList.add('active');
            document.getElementById('quoteTitle').value = '';
            document.getElementById('quoteContent').value = '';
            
            // 기본값 설정
            selectedUpsell = currentCarrier !== 'skt';
            selectedWifi = true;
            
            // 토글 상태 업데이트
            document.getElementById('upsellToggle').classList.toggle('active', selectedUpsell);
            document.getElementById('upsellLabel').textContent = selectedUpsell ? '업셀' : '업셀거부';
            document.getElementById('wifiToggle').classList.add('active');
            document.getElementById('wifiLabel').textContent = '있음';
            
            editingQuoteId = null;
            
            // 편집기로 스크롤
            document.getElementById('editorPanel').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 편집기 숨기기
        function hideEditor() {
            document.getElementById('editorPanel').classList.remove('active');
            editingQuoteId = null;
        }
        
        // 견적 저장
        async function saveQuote(event) {
            event.preventDefault();
            
            let title = document.getElementById('quoteTitle').value;
            const content = document.getElementById('quoteContent').value;
            
            // 제목에 ▷ 자동 추가
            if (!title.startsWith('▷')) {
                title = '▷ ' + title;
            }
            
            const processed = processQuoteContent(content);
            
            try {
                const quoteData = {
                    title,
                    content: processed,
                    carrier: currentCarrier,
                    mode: currentMode,
                    upsell: selectedUpsell,
                    wifi: selectedWifi,
                    updated_at: new Date().toISOString()
                };
                
                if (editingQuoteId) {
                    // 수정
                    const { error } = await supabaseClient
                        .from('quotes')
                        .update(quoteData)
                        .eq('id', editingQuoteId);
                    
                    if (error) throw error;
                    showNotification('견적이 수정되었습니다');
                } else {
                    // 신규
                    quoteData.created_at = new Date().toISOString();
                    quoteData.favorite = false;
                    
                    const { error } = await supabaseClient
                        .from('quotes')
                        .insert(quoteData);
                    
                    if (error) throw error;
                    showNotification('견적이 저장되었습니다');
                }
                
                hideEditor();
                await loadQuotes();
                
            } catch (error) {
                console.error('저장 실패:', error);
                showNotification('저장 실패', 'error');
            }
        }
        
        // 견적 수정
        function editQuote(id) {
            const quote = currentQuotes.find(q => q.id === id);
            if (!quote) return;
            
            editingQuoteId = id;
            document.getElementById('quoteTitle').value = quote.title;
            document.getElementById('quoteContent').value = quote.content;
            
            // 통신사 설정
            selectCarrier(quote.carrier || currentCarrier);
            
            // 토글 상태 설정
            selectedUpsell = quote.upsell !== false;
            selectedWifi = quote.wifi !== false;
            
            document.getElementById('upsellToggle').classList.toggle('active', selectedUpsell);
            document.getElementById('upsellLabel').textContent = selectedUpsell ? '업셀' : '업셀거부';
            document.getElementById('wifiToggle').classList.toggle('active', selectedWifi);
            document.getElementById('wifiLabel').textContent = selectedWifi ? '있음' : '없음';
            
            document.getElementById('editorPanel').classList.add('active');
            document.getElementById('editorPanel').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 견적 삭제
        async function deleteQuote(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('quotes')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('견적이 삭제되었습니다');
                await loadQuotes();
                
            } catch (error) {
                console.error('삭제 실패:', error);
                showNotification('삭제 실패', 'error');
            }
        }
        
        // 견적 복사
        function copyQuoteContent(id) {
            const quote = currentQuotes.find(q => q.id === id);
            if (!quote) return;
            
            // ★ ☆로 시작하는 줄만 추가
            const lines = quote.content.split('\n');
            const summary = lines.filter(line => 
                line.trim().startsWith('★') || line.trim().startsWith('☆')
            ).join('\n');
            
            const fullContent = summary ? 
                `${quote.title}\n\n${quote.content}\n\n${summary}` :
                `${quote.title}\n\n${quote.content}`;
                
            navigator.clipboard.writeText(fullContent).then(() => {
                showNotification('클립보드에 복사되었습니다');
            }).catch(err => {
                console.error('복사 실패:', err);
                showNotification('복사 실패', 'error');
            });
        }
        
        // 견적 선택
        function selectQuote(id) {
            // 카드 클릭 시 상세 보기 등의 기능 추가 가능
        }
        
        // 검색
        function searchQuotes() {
            filterQuotes();
        }
        
        // 알림
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show' + (type === 'error' ? ' error' : '');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
